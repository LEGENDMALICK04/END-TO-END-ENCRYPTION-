<!DOCTYPE html>
<html>
<head>
    <title>End-to-End Encrypted Chat</title>
</head>
<body>
    <h2>Secure Chat</h2>
    <textarea id="message" placeholder="Type your message"></textarea>
    <button onclick="sendMessage()">Send</button>
    <h3>Chat</h3>
    <div id="chat"></div>

    <script>
        let rsaKeys;
        let aesKey;

        async function generateRSAKeys() {
            rsaKeys = await window.crypto.subtle.generateKey(
                {name: "RSA-OAEP", modulusLength: 2048, publicExponent: new Uint8Array([1, 0, 1]), hash: "SHA-256"},
                true,
                ["encrypt", "decrypt"]
            );
        }

        async function generateAESKey() {
            aesKey = await window.crypto.subtle.generateKey(
                { name: "AES-GCM", length: 256 },
                true,
                ["encrypt", "decrypt"]
            );
        }

        async function encryptMessage(message) {
            let encoder = new TextEncoder();
            let iv = window.crypto.getRandomValues(new Uint8Array(12));
            let encrypted = await window.crypto.subtle.encrypt(
                { name: "AES-GCM", iv: iv },
                aesKey,
                encoder.encode(message)
            );
            return { cipher: new Uint8Array(encrypted), iv: iv };
        }

        async function decryptMessage(encrypted, iv) {
            let decrypted = await window.crypto.subtle.decrypt(
                { name: "AES-GCM", iv: iv },
                aesKey,
                encrypted
            );
            return new TextDecoder().decode(decrypted);
        }

        async function sendMessage() {
            let message = document.getElementById("message").value;
            let encryptedData = await encryptMessage(message);
            let chat = document.getElementById("chat");
            chat.innerHTML += `<p><b>Encrypted:</b> ${btoa(String.fromCharCode(...encryptedData.cipher))}</p>`;
            setTimeout(async () => {
                let decryptedText = await decryptMessage(encryptedData.cipher, encryptedData.iv);
                chat.innerHTML += `<p><b>Decrypted:</b> ${decryptedText}</p>`;
            }, 1000);
        }

        async function initialize() {
            await generateRSAKeys();
            await generateAESKey();
        }

        initialize();
    </script>
</body>
</html>
